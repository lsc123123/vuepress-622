(window.webpackJsonp=window.webpackJsonp||[]).push([[251],{577:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"inotifywait"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait"}},[s._v("#")]),s._v(" inotifywait")]),s._v(" "),t("p",[s._v("异步文件系统监控机制")]),s._v(" "),t("h2",{attrs:{id:"补充说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#补充说明"}},[s._v("#")]),s._v(" 补充说明")]),s._v(" "),t("p",[t("strong",[s._v("Inotify")]),s._v(" 一种强大的、细粒度的、异步文件系统监控机制，它满足各种各样的文件监控需要，可以监控文件系统的访问属性、读写属性、权限属性、删除创建、移动等操作，也就是可以监控文件发生的一切变化。。")]),s._v(" "),t("p",[t("strong",[s._v("inotify-tools")]),s._v(" 是一个C库和一组命令行的工作提供Linux下inotify的简单接口。inotify-tools安装后会得到"),t("code",[s._v("inotifywait")]),s._v("和"),t("code",[s._v("inotifywatch")]),s._v("这两条命令：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("inotifywait命令")]),s._v(" 可以用来收集有关文件访问信息，Linux发行版一般没有包括这个命令，需要安装inotify-tools，这个命令还需要将inotify支持编译入Linux内核，好在大多数Linux发行版都在内核中启用了inotify。")]),s._v(" "),t("li",[t("strong",[s._v("inotifywatch命令")]),s._v(" 用于收集关于被监视的文件系统的统计数据，包括每个 inotify 事件发生多少次。")])]),s._v(" "),t("p",[s._v("开始之前需要检测系统内核是否支持inotify：")]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("uname -r")]),s._v("命令检查Linux内核，如果低于2.6.13，就需要重新编译内核加入inotify的支持。")]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("ll /proc/sys/fs/inotify")]),s._v("命令，是否有以下三条信息输出，如果没有表示不支持。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("ll /proc/sys/fs/inotify\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Jan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":41 max_queued_events\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Jan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":41 max_user_instances\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Jan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":41 max_user_watches\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"安装inotify-tools"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装inotify-tools"}},[s._v("#")]),s._v(" 安装inotify-tools")]),s._v(" "),t("ul",[t("li",[s._v("inotify-tools项目地址：https://github.com/rvoicilas/inotify-tools")]),s._v(" "),t("li",[s._v("inotify-tools下载地址：http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#CentOS release 5.8/64位：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf inotify-tools-3.14.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" inotify-tools-3.14\n./configure\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("其他Linux发行版安装方法可以参见：https://github.com/rvoicilas/inotify-tools/wiki#wiki-getting")]),s._v(" "),t("h3",{attrs:{id:"inotify相关参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inotify相关参数"}},[s._v("#")]),s._v(" inotify相关参数")]),s._v(" "),t("p",[s._v("inotify定义了下列的接口参数，可以用来限制inotify消耗kernel memory的大小。由于这些参数都是内存参数，因此，可以根据应用需求，实时的调节其大小：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("/proc/sys/fs/inotify/max_queued_evnets")]),s._v("表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这个值的事件被丢弃，但会触发IN_Q_OVERFLOW事件。")]),s._v(" "),t("li",[t("code",[s._v("/proc/sys/fs/inotify/max_user_instances")]),s._v("表示每一个real user id可创建的inotify instatnces的数量上限。")]),s._v(" "),t("li",[t("code",[s._v("/proc/sys/fs/inotify/max_user_watches")]),s._v("表示每个inotify instatnces可监控的最大目录数量。如果监控的文件数目巨大，需要根据情况，适当增加此值的大小。")])]),s._v(" "),t("p",[s._v("根据以上在32位或者64位系统都可以执行：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("104857600")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/fs/inotify/max_user_watches\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'echo 104857600 > /proc/sys/fs/inotify/max_user_watches'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/rc.local\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如果遇到以下错误：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("inotifywait: error "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" loading shared libraries: libinotifytools.so.0: cannot "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" shared object file: No such "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" or directory \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v(" **解决方法：** \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("位系统：ln "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /usr/local/lib/libinotifytools.so.0 /usr/lib/libinotifytools.so.0\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("位系统：ln "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /usr/local/lib/libinotifytools.so.0 /usr/lib64/libinotifytools.so.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"inotifywait命令使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait命令使用"}},[s._v("#")]),s._v(" inotifywait命令使用")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#filename watchdir.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n/usr/local/bin/inotifywait "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-mrq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--timefmt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%d/%m/%y/%H:%M'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%T %w %f'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" modify,delete,create,attrib "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$path")]),s._v("\n\n执行输出：\n./watchdir.sh /data/wsdata/tools/\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:35 /data/wsdata/tools/ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4913")]),s._v("\n04/01/13/16:35 /data/wsdata/tools/ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4913")]),s._v("\n04/01/13/16:35 /data/wsdata/tools/ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4913")]),s._v("\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp~\n04/01/13/16:35 /data/wsdata/tools/ .j.jsp.swp\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("h3",{attrs:{id:"inotifywait命令参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait命令参数"}},[s._v("#")]),s._v(" inotifywait命令参数")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("-m")]),s._v("是要持续监视变化。")]),s._v(" "),t("li",[t("code",[s._v("-r")]),s._v("使用递归形式监视目录。")]),s._v(" "),t("li",[t("code",[s._v("-q")]),s._v("减少冗余信息，只打印出需要的信息。")]),s._v(" "),t("li",[t("code",[s._v("-e")]),s._v("指定要监视的事件列表。")]),s._v(" "),t("li",[t("code",[s._v("--timefmt")]),s._v("是指定时间的输出格式。")]),s._v(" "),t("li",[t("code",[s._v("--format")]),s._v("指定文件变化的详细信息。")])]),s._v(" "),t("h3",{attrs:{id:"可监听的事件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可监听的事件"}},[s._v("#")]),s._v(" 可监听的事件")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("事件")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("access")]),s._v(" "),t("td",[t("strong",[s._v("访问")]),s._v(" ，读取文件。")])]),s._v(" "),t("tr",[t("td",[s._v("modify")]),s._v(" "),t("td",[t("strong",[s._v("修改")]),s._v(" ，文件内容被修改。")])]),s._v(" "),t("tr",[t("td",[s._v("attrib")]),s._v(" "),t("td",[t("strong",[s._v("属性")]),s._v(" ，文件元数据被修改。")])]),s._v(" "),t("tr",[t("td",[s._v("move")]),s._v(" "),t("td",[t("strong",[s._v("移动")]),s._v(" ，对文件进行移动操作。")])]),s._v(" "),t("tr",[t("td",[s._v("create")]),s._v(" "),t("td",[t("strong",[s._v("创建")]),s._v(" ，生成新文件")])]),s._v(" "),t("tr",[t("td",[s._v("open")]),s._v(" "),t("td",[t("strong",[s._v("打开")]),s._v(" ，对文件进行打开操作。")])]),s._v(" "),t("tr",[t("td",[s._v("close")]),s._v(" "),t("td",[t("strong",[s._v("关闭")]),s._v(" ，对文件进行关闭操作。")])]),s._v(" "),t("tr",[t("td",[s._v("delete")]),s._v(" "),t("td",[t("strong",[s._v("删除")]),s._v(" ，文件被删除。")])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);